FROM docker.n8n.io/n8nio/n8n:latest

# Установка системных утилит
USER root
RUN apk add --no-cache \
    python3 \
    py3-pip \
    ffmpeg \
    git \
    curl \
    bash \
    build-base \
    libffi-dev \
    openssl-dev \
    make \
    gcc \
    g++ \
    libc6-compat \
    libstdc++ \
    linux-headers \
    zlib-dev

# Создание виртуального окружения для pip
RUN python3 -m venv /venv
ENV PATH="/venv/bin:$PATH"

# Установка pip-библиотек
RUN pip install --no-cache-dir \
    yt-dlp \
    ffmpeg-python \
    openai \
    google-api-python-client \
    google-auth \
    telethon

# Установка npm-библиотек
RUN npm install -g \
    axios \
    node-fetch \
    form-data \
    moment \
    date-fns \
    lodash \
    fs-extra \
    path \
    csv-parser \
    xml2js \
    js-yaml \
    xlsx \
    jsonwebtoken \
    simple-oauth2 \
    uuid \
    openai \
    @tensorflow/tfjs-node \
    langchain \
    langchain-openai \
    node-telegram-bot-api \
    discord.js \
    vk-io \
    whatsapp-web.js \
    fluent-ffmpeg \
    ffmpeg-static \
    yt-dlp-exec \
    google-tts-api \
    @vitalets/google-translate-token \
    node-wav \
    lame \
    googleapis \
    @supabase/supabase-js \
    pg \
    mongoose \
    ioredis \
    bcrypt \
    validator \
    joi \
    winston \
    dotenv \
    prom-client \
    node-downloader-helper \
    adm-zip \
    archiver

# Установка прав
RUN chown -R node:node /home/node && chmod -R 775 /home/node

USER node
