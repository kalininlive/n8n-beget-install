FROM node:20-alpine

USER root

RUN apk add --no-cache \
  bash \
  curl \
  git \
  make \
  g++ \
  gcc \
  python3 \
  py3-pip \
  libffi-dev \
  ffmpeg \
  apache2-utils

RUN pip3 install yt-dlp --break-system-packages

ARG DOCKER_GID=999
RUN addgroup -g ${DOCKER_GID} docker || true && adduser node docker || true

RUN npm config set fund false && npm config set audit false

RUN npm install -g n8n@2.5.0 \
  axios \
  node-fetch \
  form-data \
  moment \
  date-fns \
  lodash \
  fs-extra \
  csv-parser \
  xml2js \
  js-yaml \
  xlsx \
  jsonwebtoken \
  simple-oauth2 \
  uuid \
  openai \
  langchain \
  fluent-ffmpeg \
  oauth-1.0a

USER node

ENTRYPOINT ["n8n"]
