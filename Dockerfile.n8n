FROM node:20-alpine

USER root

# Системные пакеты
RUN apk add --no-cache --update \
  bash \
  curl \
  git \
  make \
  g++ \
  gcc \
  python3 \
  py3-pip \
  libffi-dev \
  ffmpeg \
  apache2-utils \
  docker-cli \
  shadow

# yt-dlp
RUN pip3 install yt-dlp --break-system-packages

# Docker group
ARG DOCKER_GID=999
RUN groupadd -g ${DOCKER_GID} docker || groupadd docker || true && \
    usermod -aG docker node

# n8n
RUN npm install -g n8n@2.5.0

# npm пакеты (ТОЧНО ТВОЙ СПИСОК)
RUN npm config set fund false && npm config set audit false && \
npm install -g \
  axios \
  node-fetch \
  form-data \
  moment \
  date-fns \
  lodash \
  fs-extra \
  path \
  csv-parser \
  xml2js \
  js-yaml \
  xlsx \
  jsonwebtoken \
  simple-oauth2 \
  uuid \
  openai \
  @tensorflow/tfjs-node \
  langchain \
  node-telegram-bot-api \
  discord.js \
  vk-io \
  whatsapp-web.js \
  fluent-ffmpeg \
  ffmpeg-static \
  google-tts-api \
  @vitalets/google-translate-token \
  node-wav \
  mongoose \
  ioredis \
  bcrypt \
  validator \
  joi \
  winston \
  dotenv \
  prom-client \
  node-downloader-helper \
  adm-zip \
  archiver \
  oauth-1.0a

USER node
ENTRYPOINT ["n8n"]
