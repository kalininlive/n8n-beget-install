FROM n8nio/n8n:1.91.2

# Установка системных зависимостей
USER root

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    ffmpeg \
    curl \
    unzip \
    git \
    zip \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Установка yt-dlp
RUN curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp \
  && chmod a+rx /usr/local/bin/yt-dlp

# Установка глобальных npm-зависимостей
RUN npm install -g \
    axios \
    node-fetch \
    form-data \
    moment \
    date-fns \
    lodash \
    fs-extra \
    csv-parser \
    xml2js \
    js-yaml \
    xlsx \
    jsonwebtoken \
    simple-oauth2 \
    uuid \
    openai \
    @tensorflow/tfjs-node \
    langchain \
    langchain-openai \
    node-telegram-bot-api \
    discord.js \
    vk-io \
    whatsapp-web.js \
    fluent-ffmpeg \
    google-tts-api \
    @vitalets/google-translate-token \
    node-wav \
    lame \
    googleapis \
    @supabase/supabase-js \
    pg \
    mongoose \
    ioredis \
    bcrypt \
    validator \
    joi \
    winston \
    dotenv \
    prom-client \
    node-downloader-helper \
    adm-zip \
    archiver

# Установка pip-зависимостей (по необходимости)
RUN pip3 install --no-cache-dir \
    requests \
    openai \
    google-api-python-client \
    beautifulsoup4

# Возврат прав к пользователю node
USER node
